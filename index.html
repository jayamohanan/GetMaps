<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kerala Administrative Boundaries Viewer</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAo9zAB2j8jQ3J" crossorigin=""/>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-nmM3X0t2N7Qh/2KLVdU5ZpJ1t30T5Xee4zpF2xEOJxA=" crossorigin=""></script>

    <!-- Simple CSS for layout -->
    <style>
        body, html {
            margin: 0; padding: 0;
            height: 100%; width: 100%;
            font-family: Arial, sans-serif;
        }
        #container {
            display: flex;
            height: 100%;
        }
        #sidebar {
            width: 350px;
            overflow-y: auto;
            border-right: 1px solid #ccc;
            padding: 10px;
            box-sizing: border-box;
        }
        #map {
            flex: 1;
        }
        .panel {
            border: 1px solid #aaa;
            padding: 10px;
            margin-bottom: 10px;
        }
        .panel h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
        }
        .color-opacity {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
        }
        .timestamp {
            position: absolute;
            top: 5px;
            right: 10px;
            background: rgba(255,255,255,0.8);
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 12px;
        }
        .checkbox-group {
            margin-top: 5px;
        }
    </style>
</head>
<body>
<div id="container">
    <div id="sidebar">
        <button id="addPanelBtn">+ Add Panel</button>
        <div id="panelsContainer"></div>
    </div>
    <div id="map"></div>
</div>
<div class="timestamp">Last edited: Wed, 9:21</div>

<script>
    // Initialize map
    const map = L.map('map').setView([10.8505, 76.2711], 7);

    const baseLayers = {
        "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: '© OpenStreetMap contributors'}).addTo(map),
        "OpenTopoMap": L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {attribution: '© OpenTopoMap contributors'})
    };
    L.control.layers(baseLayers).addTo(map);

    // Global store for layers by panel
    const panelLayers = {};

    // Load GeoJSON files
    const geojsonFiles = {
        state: 'state_v15.2.geojson',
        district: 'district_V15.geojson',
        assembly: 'assembly_V15.geojson',
        lsg: 'lsg_V15.geojson'
    };

    const geoData = {};

    async function loadGeoJSON(name, path) {
        const res = await fetch(path);
        geoData[name] = await res.json();
    }

    Promise.all(Object.entries(geojsonFiles).map(([name, path]) => loadGeoJSON(name, path)));

    // Panel management
    let panelCount = 0;
    const panelsContainer = document.getElementById('panelsContainer');
    const addPanelBtn = document.getElementById('addPanelBtn');

    addPanelBtn.addEventListener('click', () => createPanel());

    function createPanel() {
        panelCount++;
        const panelId = `panel${panelCount}`;
        const panelDiv = document.createElement('div');
        panelDiv.className = 'panel';
        panelDiv.id = panelId;

        panelDiv.innerHTML = `
            <h3>Panel ${panelCount}</h3>
            <label>Type:
                <select class="typeSelect">
                    <option value="">Select</option>
                    <option value="state">State</option>
                    <option value="district">District</option>
                    <option value="assembly">Assembly</option>
                    <option value="lsg">Local Body</option>
                </select>
            </label>
            <br>
            <label>Name:
                <input type="text" class="nameInput" disabled placeholder="Select type first">
            </label>
            <div class="checkbox-group">
                <label><input type="checkbox" class="parentCb"> Parents</label>
                <label><input type="checkbox" class="childrenCb"> Children</label>
                <label><input type="checkbox" class="siblingCb"> Siblings</label>
            </div>
            <div class="color-opacity">
                <label>Color: <input type="color" class="colorPicker" value="#000000"></label>
                <label>Opacity: <input type="range" class="opacitySlider" min="0" max="1" step="0.05" value="0.5"></label>
            </div>
            <br>
            <button class="drawBtn">Draw</button>
            <button class="clearBtn">Clear</button>
        `;

        panelsContainer.appendChild(panelDiv);

        const typeSelect = panelDiv.querySelector('.typeSelect');
        const nameInput = panelDiv.querySelector('.nameInput');
        const parentCb = panelDiv.querySelector('.parentCb');
        const childrenCb = panelDiv.querySelector('.childrenCb');
        const siblingCb = panelDiv.querySelector('.siblingCb');
        const colorPicker = panelDiv.querySelector('.colorPicker');
        const opacitySlider = panelDiv.querySelector('.opacitySlider');
        const drawBtn = panelDiv.querySelector('.drawBtn');
        const clearBtn = panelDiv.querySelector('.clearBtn');

        typeSelect.addEventListener('change', () => {
            nameInput.disabled = !typeSelect.value;
            // Reset checkboxes
            parentCb.checked = false;
            childrenCb.checked = false;
            siblingCb.checked = false;
        });

        drawBtn.addEventListener('click', () => {
            if (!typeSelect.value || !nameInput.value) return;
            drawBoundaries(panelId, typeSelect.value, nameInput.value, {
                parents: parentCb.checked,
                children: childrenCb.checked,
                siblings: siblingCb.checked,
                color: colorPicker.value,
                opacity: parseFloat(opacitySlider.value)
            });
        });

        clearBtn.addEventListener('click', () => {
            if(panelLayers[panelId]){
                panelLayers[panelId].forEach(layer => map.removeLayer(layer));
                panelLayers[panelId] = [];
            }
        });
    }

    function drawBoundaries(panelId, type, name, options) {
        if (!panelLayers[panelId]) panelLayers[panelId] = [];

        const layers = [];
        const color = options.color;
        const opacity = options.opacity;

        // Utility to add a GeoJSON feature
        const addFeature = (feature) => {
            const layer = L.geoJSON(feature, {
                style: { color: color, fillOpacity: opacity }
            }).addTo(map);
            layers.push(layer);
        }

        const findByName = (typeKey, nameVal) => {
            if (!geoData[typeKey]) return null;
            return geoData[typeKey].features.filter(f => f.properties.Name && f.properties.Name.toLowerCase() === nameVal.toLowerCase());
        }

        // Draw main selection
        const mainFeatures = findByName(type, name);
        mainFeatures.forEach(addFeature);

        // Placeholder for hierarchical logic (parents/children/siblings)
        // In practice, you need to implement this using geoData relationships

        panelLayers[panelId].push(...layers);

        if(layers.length > 0){
            map.fitBounds(L.featureGroup(layers).getBounds());
        }
    }

    // Initialize first panel
    createPanel();
</script>
</body>
</html>
