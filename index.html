<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>q Kerala Administrative Boundaries Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Custom CSS -->
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
      display: flex;
    }
    #sidebar {
      width: 340px;
      min-width: 320px;
      max-width: 350px;
      background: #f9f9f9;
      border-right: 1px solid #ccc;
      padding: 10px;
      overflow-y: auto;
    }
    #map {
      flex: 1;
      min-width: 400px;
      height: 100vh;
    }
    .panel {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 15px;
      background: #fff;
    }
    .panel h4 {
      margin: 0 0 10px 0;
      font-size: 16px;
    }
    .form-group {
      margin-bottom: 10px;
    }
    select, input[type="text"] {
      width: 100%;
      padding: 6px;
      font-size: 14px;
    }
    .checkbox-group {
      margin: 8px 0;
    }
    .btn {
      display: inline-block;
      padding: 6px 10px;
      margin-right: 5px;
      font-size: 14px;
      cursor: pointer;
      border: 1px solid #aaa;
      border-radius: 4px;
      background: #eee;
    }
    .btn:hover {
      background: #ddd;
    }
    #addPanelBtn {
      width: 100%;
      margin-top: 10px;
      background: #007bff;
      color: #fff;
      border: none;
    }
    .spinner {
      display: none;
      width: 16px;
      height: 16px;
      border: 2px solid #ccc;
      border-top: 2px solid #333;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-left: 5px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    /* Mobile responsiveness */
    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }
      #sidebar {
        width: 100%;
        max-width: 100%;
        border-right: none;
        border-bottom: 1px solid #ccc;
      }
      #map {
        height: calc(100vh - 300px);
      }
    }
    /* Error popup */
    .popup {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border: 2px solid #444;
      padding: 20px;
      z-index: 2000;
      display: none;
    }
    .popup button {
      margin-top: 10px;
      padding: 6px 12px;
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <div id="panels"></div>
    <button id="addPanelBtn" class="btn">+ Add New Panel</button>
  </div>
  <div id="map"></div>

  <!-- Error popup -->
  <div id="errorPopup" class="popup">
    <div id="errorMessage"></div>
    <button onclick="closePopup()">OK</button>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ===== Map Setup =====
    const map = L.map('map').setView([10.8505, 76.2711], 7);

    const baseMaps = {
      "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
      "OpenTopoMap": L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png'),
      "Blank": L.tileLayer('', { attribution: '' })
    };

    baseMaps.OpenStreetMap.addTo(map);
    L.control.layers(baseMaps, null, { position: 'topright' }).addTo(map);

    // ===== Global State =====
    const geojsonFiles = {
      "State": "state_V17.geojson",
      "District": "district_V17.geojson",
      "Assembly": "assembly_V17.geojson",
      "Local body": "lsg_V17.geojson"
    };

    const cachedData = {};   // cache loaded GeoJSON
    const panelCount = { value: 0 };
    const drawnLayers = {};  // store drawn layers per panel

    // ===== Utility: Load GeoJSON with error handling =====
    async function loadGeoJSON(file) {
      if (cachedData[file]) return cachedData[file];
      try {
        const response = await fetch(file);
        if (!response.ok) throw new Error(`Data file ${file} not found`);
        const data = await response.json();
        cachedData[file] = data;
        return data;
      } catch (err) {
        showPopup(err.message);
        return { type: "FeatureCollection", features: [] };
      }
    }

    // ===== Panel Creation =====
    function createPanel() {
      panelCount.value++;
      const panelId = panelCount.value;
      const panel = document.createElement('div');
      panel.className = 'panel';
      panel.dataset.panelId = panelId;
      panel.innerHTML = `
        <h4>Panel ${panelId}</h4>
        <div class="form-group">
          <label>Type:</label>
          <select class="typeSelect">
            <option value="">-- Select Type --</option>
            <option>State</option>
            <option>District</option>
            <option>Assembly</option>
            <option>Local body</option>
          </select>
        </div>
        <div class="form-group">
          <label>Name:</label>
          <input type="text" class="nameInput" placeholder="Search name..." disabled>
          <div class="nameDropdown"></div>
        </div>
        <div class="checkbox-group"></div>
        <div class="form-group">
          <label>Boundary Color:</label>
          <input type="color" class="colorPicker" value="#000000">
        </div>
        <div class="form-group">
          <label>Transparency:</label>
          <input type="range" class="transparencySlider" min="0" max="100" value="0">
        </div>
        <div class="form-group">
          <button class="btn drawBtn">Draw <div class="spinner"></div></button>
          <button class="btn clearBtn">Clear</button>
        </div>
      `;
      document.getElementById('panels').appendChild(panel);

      setupPanelEvents(panel, panelId);
    }

    // ===== Setup Events =====
    function setupPanelEvents(panel, panelId) {
      const typeSelect = panel.querySelector('.typeSelect');
      const nameInput = panel.querySelector('.nameInput');
      const nameDropdown = panel.querySelector('.nameDropdown');
      const drawBtn = panel.querySelector('.drawBtn');
      const spinner = panel.querySelector('.spinner');
      const clearBtn = panel.querySelector('.clearBtn');

      // Type selection â†’ enable name input
      typeSelect.addEventListener('change', async () => {
        const type = typeSelect.value;
        nameInput.value = '';
        nameInput.disabled = !type;
        nameDropdown.innerHTML = '';
        if (type) {
          const data = await loadGeoJSON(geojsonFiles[type]);
          const names = data.features.map(f => f.properties.Name);
          populateNameDropdown(names, nameDropdown, nameInput);
        }
      });

      // Live search filtering
      nameInput.addEventListener('input', () => {
        const items = [...nameDropdown.querySelectorAll('div')];
        const query = nameInput.value.toLowerCase();
        let matches = 0;
        items.forEach(item => {
          if (item.textContent.toLowerCase().includes(query)) {
            item.style.display = '';
            matches++;
          } else {
            item.style.display = 'none';
          }
        });
        if (matches === 0) {
          nameDropdown.innerHTML = '<div>No matches found</div>';
        }
      });

      // Draw button
      drawBtn.addEventListener('click', async () => {
        const type = typeSelect.value;
        const name = nameInput.value.trim();
        if (!type || !name) {
          showPopup("Please select type and name before drawing.");
          return;
        }
        spinner.style.display = 'inline-block';
        try {
          const data = await loadGeoJSON(geojsonFiles[type]);
          const feature = data.features.find(f => f.properties.Name.toLowerCase() === name.toLowerCase());
          if (!feature) {
            showPopup(`No boundary found for '${name}' in ${type} data`);
            return;
          }
          // Clear previous
          if (drawnLayers[panelId]) {
            map.removeLayer(drawnLayers[panelId]);
          }
          const color = panel.querySelector('.colorPicker').value;
          const transparency = panel.querySelector('.transparencySlider').value;
          const layer = L.geoJSON(feature, {
            style: {
              color: color,
              weight: 2,
              fillColor: color,
              fillOpacity: transparency/100
            }
          }).addTo(map);
          drawnLayers[panelId] = layer;
          map.fitBounds(layer.getBounds());
        } catch (err) {
          showPopup("Failed to draw boundary. Please try again");
          console.error(err);
        } finally {
          spinner.style.display = 'none';
        }
      });

      // Clear button
      clearBtn.addEventListener('click', () => {
        if (drawnLayers[panelId]) {
          map.removeLayer(drawnLayers[panelId]);
          delete drawnLayers[panelId];
        }
      });
    }

    // ===== Populate Name Dropdown =====
    function populateNameDropdown(names, dropdown, input) {
      dropdown.innerHTML = '';
      names.forEach(n => {
        const div = document.createElement('div');
        div.textContent = n;
        div.style.cursor = 'pointer';
        div.addEventListener('click', () => {
          input.value = n;
          dropdown.innerHTML = '';
        });
        dropdown.appendChild(div);
      });
    }

    // ===== Error popup =====
    function showPopup(msg) {
      document.getElementById('errorMessage').textContent = msg;
      document.getElementById('errorPopup').style.display = 'block';
    }
    function closePopup() {
      document.getElementById('errorPopup').style.display = 'none';
    }

    // ===== Init =====
    window.onload = () => {
      createPanel();  // initial panel
      document.getElementById('addPanelBtn').addEventListener('click', createPanel);
    };
  </script>
</body>
</html>
