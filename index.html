<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kerala Administrative Boundaries Viewer</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4xn+LwB4D6/uG5v/9YmXLqg+/c5T4kDjvL5u3rFtkM=" crossorigin=""/>
    <!-- Choices.js CSS for searchable select -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
    <style>
        body, html { margin:0; padding:0; height:100%; font-family: Arial, sans-serif; }
        #container { display:flex; height:100vh; }
        #sidebar { width: 320px; overflow-y:auto; padding:10px; background:#f9f9f9; border-right:1px solid #ccc; }
        #map { flex:1; }
        .panel { border:1px solid #ccc; padding:10px; margin-bottom:10px; border-radius:5px; background:#fff; }
        .panel-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:5px; }
        .panel-header button { cursor:pointer; }
        .checkbox-group { margin:5px 0; }
        label { display:block; margin-bottom:3px; font-size:14px; }
        .timestamp { position:absolute; top:10px; right:10px; background:rgba(255,255,255,0.8); padding:5px 10px; border-radius:5px; font-size:14px; z-index:1000; }
    </style>
</head>
<body>
<div class="timestamp" id="timestamp"></div>
<div id="container">
    <div id="sidebar">
        <button id="addPanelBtn">+ Add Panel</button>
        <div id="panelsContainer"></div>
    </div>
    <div id="map"></div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-o9N1j96b1syZg6w1mk5a2hH1Vwx5dW2vB9f+DxPa4I8=" crossorigin=""></script>
<!-- Choices.js for searchable select -->
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script>
    // Initialize map
    const map = L.map('map').setView([10.8505, 76.2711], 7);

    // Base maps
    const baseMaps = {
        "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'&copy; OpenStreetMap'}),
        "OpenTopoMap": L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {maxZoom:17, attribution:'&copy; OpenTopoMap'}),
        "Blank": L.tileLayer('', {maxZoom:19})
    };
    baseMaps.OpenStreetMap.addTo(map);

    L.control.layers(baseMaps).addTo(map);

    // Track layers per panel
    let panelCounter = 0;
    const panelLayers = {};

    // Update timestamp
    const timestampEl = document.getElementById('timestamp');
    const now = new Date();
    const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    const pad = n => n.toString().padStart(2,'0');
    timestampEl.textContent = `${days[now.getDay()]}, ${pad(now.getHours())}:${pad(now.getMinutes())}`;

    // Add new panel
    document.getElementById('addPanelBtn').addEventListener('click', () => {
        addPanel();
    });

    function addPanel() {
        panelCounter++;
        const panelId = `panel${panelCounter}`;
        const container = document.getElementById('panelsContainer');

        const panelDiv = document.createElement('div');
        panelDiv.className = 'panel';
        panelDiv.id = panelId;

        panelDiv.innerHTML = `
            <div class="panel-header">
                <strong>Panel ${panelCounter}</strong>
                <button class="removeBtn">x</button>
            </div>
            <label>Type:</label>
            <select class="typeSelect">
                <option value="">--Select Type--</option>
                <option value="State">State</option>
                <option value="District">District</option>
                <option value="Assembly">Assembly</option>
                <option value="Local">Local body</option>
            </select>
            <label>Name:</label>
            <select class="nameSelect" disabled></select>
            <div class="checkbox-group" style="display:none;">
                <label><input type="checkbox" class="parentChk"> Parent</label>
                <label><input type="checkbox" class="childrenChk"> Children</label>
                <label><input type="checkbox" class="siblingsChk"> Siblings</label>
            </div>
            <label>Color:</label>
            <input type="color" class="colorPicker" value="#000000">
            <label>Opacity:</label>
            <input type="range" class="opacitySlider" min="0" max="1" step="0.1" value="0.5">
            <div style="margin-top:5px;">
                <button class="drawBtn">Draw</button>
                <button class="clearBtn">Clear</button>
            </div>
        `;
        container.appendChild(panelDiv);

        const typeSelect = panelDiv.querySelector('.typeSelect');
        const nameSelect = panelDiv.querySelector('.nameSelect');
        const checkboxGroup = panelDiv.querySelector('.checkbox-group');
        const drawBtn = panelDiv.querySelector('.drawBtn');
        const clearBtn = panelDiv.querySelector('.clearBtn');
        const colorPicker = panelDiv.querySelector('.colorPicker');
        const opacitySlider = panelDiv.querySelector('.opacitySlider');

        new Choices(nameSelect, { searchEnabled:true, shouldSort:false });

        typeSelect.addEventListener('change', async function() {
            const type = this.value;
            nameSelect.innerHTML = '';
            if(!type) { nameSelect.disabled = true; checkboxGroup.style.display='none'; return; }
            nameSelect.disabled = false;
            checkboxGroup.style.display='block';

            // Load GeoJSON names dynamically
            let geojsonFile = '';
            if(type==='State') geojsonFile = 'state_v15.2.geojson';
            else if(type==='District') geojsonFile = 'district_V15.geojson';
            else if(type==='Assembly') geojsonFile = 'assembly_V15.geojson';
            else if(type==='Local') geojsonFile = 'lsg_V15.geojson';

            try {
                const res = await fetch(geojsonFile);
                const data = await res.json();
                const names = data.features.map(f => f.properties.Name).filter(n=>n);
                names.forEach(n => {
                    const opt = document.createElement('option');
                    opt.value = n;
                    opt.textContent = n;
                    nameSelect.appendChild(opt);
                });
                nameSelect._choices?.setChoices(Array.from(nameSelect.options).map(o=>({value:o.value,label:o.textContent})), 'value', 'label', true);
            } catch(e) {
                console.error("Error loading GeoJSON:", e);
            }
        });

        drawBtn.addEventListener('click', async function() {
            const type = typeSelect.value;
            const name = nameSelect.value;
            if(!type || !name) { alert('Select type and name'); return; }

            const color = colorPicker.value;
            const opacity = parseFloat(opacitySlider.value);
            let geojsonFile = '';
            if(type==='State') geojsonFile = 'state_v15.2.geojson';
            else if(type==='District') geojsonFile = 'district_V15.geojson';
            else if(type==='Assembly') geojsonFile = 'assembly_V15.geojson';
            else if(type==='Local') geojsonFile = 'lsg_V15.geojson';

            try {
                const res = await fetch(geojsonFile);
                const data = await res.json();
                const feature = data.features.find(f=>f.properties.Name===name);
                if(!feature) { alert('Boundary not found'); return; }

                // Create layer
                const layer = L.geoJSON(feature, {color:color, fillOpacity:opacity});
                if(!panelLayers[panelId]) panelLayers[panelId] = [];
                panelLayers[panelId].push(layer);
                layer.addTo(map);
                map.fitBounds(layer.getBounds());
            } catch(e) { console.error(e); }
        });

        clearBtn.addEventListener('click', () => {
            if(panelLayers[panelId]) {
                panelLayers[panelId].forEach(l => map.removeLayer(l));
                panelLayers[panelId] = [];
            }
        });

        panelDiv.querySelector('.removeBtn').addEventListener('click', () => {
            clearBtn.click();
            panelDiv.remove();
        });
    }

    // Initialize first panel
    addPanel();
</script>
</body>
</html>
