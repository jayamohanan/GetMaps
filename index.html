<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kerala Administrative Boundaries Viewer</title>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Custom Styles -->
  <style>
    body, html {
      margin: 0; padding: 0; height: 100%; width: 100%;
      font-family: Arial, sans-serif;
    }
    #app {
      display: flex; height: 100%; width: 100%;
    }
    #sidebar {
      width: 340px; min-width: 320px; max-width: 350px;
      background: #f9f9f9; border-right: 1px solid #ccc;
      padding: 10px; overflow-y: auto;
    }
    #map {
      flex: 1; min-width: 400px;
    }
    .panel {
      border: 1px solid #ddd; border-radius: 8px;
      padding: 10px; margin-bottom: 15px; background: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .panel h3 {
      margin: 0 0 10px; font-size: 16px;
    }
    .form-group {
      margin-bottom: 10px;
    }
    select, input[type="text"], input[type="color"], input[type="range"], button {
      width: 100%; padding: 6px; margin-top: 4px;
    }
    button {
      cursor: pointer; border: none; border-radius: 4px;
      padding: 8px; margin-top: 5px;
    }
    .draw-btn { background: #007bff; color: #fff; }
    .clear-btn { background: #dc3545; color: #fff; }
    .add-btn { background: #28a745; color: #fff; width: 100%; }
    .hidden { display: none; }
    @media (max-width: 768px) {
      #app { flex-direction: column; }
      #sidebar { width: 100%; max-width: none; }
      #map { min-width: 100%; height: 60vh; }
    }
  </style>
</head>
<body>
<div id="app">
  <div id="sidebar">
    <h2>Kerala Boundaries Viewer</h2>
    <div id="panels"></div>
    <button id="addPanel" class="add-btn">+ Add New Panel</button>
  </div>
  <div id="map"></div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  // =========================
  // Global Config and State
  // =========================
  const map = L.map('map').setView([10.8505, 76.2711], 7);
  const geojsonCache = {}; // cache loaded data
  const panels = {};
  let panelCounter = 1;

  // Base maps
  const baseLayers = {
    "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OSM contributors'
    }).addTo(map),
    "OpenTopoMap": L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenTopoMap'
    }),
    "Blank": L.tileLayer('', { attribution: '' })
  };
  L.control.layers(baseLayers, {}).addTo(map);

  // =========================
  // Utility: Popup Errors
  // =========================
  function showError(msg) {
    alert(msg); // Replace with modal if needed
    console.error(msg);
  }

  // =========================
  // Load GeoJSON (cached)
  // =========================
  async function loadGeoJSON(name, file) {
    if (geojsonCache[name]) return geojsonCache[name];
    try {
      const resp = await fetch(file);
      if (!resp.ok) throw new Error("File missing");
      const data = await resp.json();
      geojsonCache[name] = data;
      return data;
    } catch (err) {
      showError(`Error loading ${file}: ${err.message}`);
      geojsonCache[name] = { type: "FeatureCollection", features: [] };
      return geojsonCache[name];
    }
  }

  // =========================
  // Panel Creation
  // =========================
  function createPanel(id) {
    const container = document.createElement('div');
    container.className = 'panel';
    container.innerHTML = `
      <h3>Panel ${id}</h3>
      <div class="form-group">
        <label>Type</label>
        <select class="typeSelect">
          <option value="">Select Type</option>
          <option value="state">State</option>
          <option value="district">District</option>
          <option value="assembly">Assembly</option>
          <option value="lsg">Local body</option>
        </select>
      </div>
      <div class="form-group">
        <label>Name</label>
        <input type="text" class="nameInput" placeholder="Search name..." disabled>
        <div class="nameResults hidden"></div>
      </div>
      <div class="form-group relationships hidden"></div>
      <div class="form-group">
        <label>Color</label>
        <input type="color" class="colorPicker" value="#000000">
      </div>
      <div class="form-group">
        <label>Transparency</label>
        <input type="range" class="transparency" min="0" max="100" value="0">
      </div>
      <button class="draw-btn">Draw</button>
      <button class="clear-btn">Clear</button>
    `;
    document.getElementById('panels').appendChild(container);

    panels[id] = {
      container,
      layers: []
    };

    // Event wiring will go here (type select, search, draw, clear...)
  }

  // =========================
  // Init
  // =========================
  async function init() {
    // Load all datasets in parallel
    await Promise.all([
      loadGeoJSON("state", "state_V17.geojson"),
      loadGeoJSON("district", "district_V17.geojson"),
      loadGeoJSON("assembly", "assembly_V17.geojson"),
      loadGeoJSON("lsg", "lsg_V17.geojson")
    ]);

    // Add first panel
    createPanel(panelCounter++);

    // Add button handler
    document.getElementById('addPanel').addEventListener('click', () => {
      createPanel(panelCounter++);
    });
  }

  init();
</script>
</body>
</html>
