<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>2we Kerala Administrative Boundaries Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { margin: 0; display: flex; height: 100vh; font-family: Arial, sans-serif; }
    #sidebar { width: 340px; padding: 15px; box-sizing: border-box; background: #f7f7f7; overflow-y: auto; border-right: 1px solid #ddd; }
    #map { flex: 1; }
    .form-group { margin-bottom: 10px; }
    label { display: block; margin-bottom: 4px; font-weight: bold; }
    input, select { width: 100%; padding: 6px; }
    button { padding: 8px 12px; margin-right: 6px; cursor: pointer; }
    #loadingSpinner { display: none; margin-left: 8px; }
    @media(max-width: 768px) { #sidebar { width: 100%; position: absolute; z-index: 1000; height: auto; border-right: none; border-bottom: 1px solid #ddd; } #map { margin-top: 400px; } }
  </style>
</head>
<body>
  <div id="sidebar">
    <h2>Kerala Boundaries Viewer</h2>
    <div class="form-group">
      <label>Enter State Name</label>
      <input type="text" id="stateInput" placeholder="Kerala">
    </div>
    <div class="form-group">
      <label>Enter District Name</label>
      <input type="text" id="districtInput" placeholder="e.g., Kottayam">
    </div>
    <div class="form-group">
      <label>Enter Assembly Name</label>
      <input type="text" id="assemblyInput" placeholder="e.g., Pala">
    </div>
    <div class="form-group">
      <label>Enter Local Body Name</label>
      <input type="text" id="lsgInput" placeholder="e.g., Pala Municipality">
    </div>
    <div class="form-group">
      <label>Boundary Color</label>
      <input type="color" id="colorPicker" value="#000000">
    </div>
    <div class="form-group">
      <label>Fill Transparency</label>
      <input type="range" id="transparencySlider" min="0" max="100" value="0">
    </div>
    <div>
      <button id="drawBtn">Draw</button>
      <button id="clearBtn">Clear</button>
      <span id="loadingSpinner">⏳</span>
    </div>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // --- Map Initialization ---
    let map;
    try {
      map = L.map('map').setView([10.8505, 76.2711], 7);
    } catch (err) {
      alert("Map failed to initialize. Please refresh the page");
      console.error("Map init error:", err);
    }

    const baseMaps = {
      "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap'
      }),
      "OpenTopoMap": L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenTopoMap'
      }),
      "Blank": L.tileLayer('', {})
    };

    baseMaps["OpenStreetMap"].addTo(map);
    L.control.layers(baseMaps).addTo(map);

    // --- Layer containers ---
    let stateLayer, districtLayer, assemblyLayer, lsgLayer;

    function loadGeoJSON(filename) {
      return fetch(filename)
        .then(resp => {
          if (!resp.ok) {
            alert(`Data file ${filename} not found`);
            console.error("Missing file:", filename);
            return null;
          }
          return resp.json();
        })
        .catch(err => {
          alert(`Data file ${filename} not found`);
          console.error("Error loading file", filename, err);
          return null;
        });
    }

    async function drawBoundaries() {
      document.getElementById("loadingSpinner").style.display = "inline";

      const stateName = document.getElementById("stateInput").value.trim();
      const districtName = document.getElementById("districtInput").value.trim();
      const assemblyName = document.getElementById("assemblyInput").value.trim();
      const lsgName = document.getElementById("lsgInput").value.trim();

      const color = document.getElementById("colorPicker").value;
      const transparency = document.getElementById("transparencySlider").value;
      const fillOpacity = (100 - transparency) / 100;

      try {
        if (stateName) {
          const stateData = await loadGeoJSON("state_V17.geojson");
          if (stateData) {
            const feature = stateData.features.find(f => f.properties.Name.toLowerCase() === stateName.toLowerCase());
            if (!feature) { alert(`No boundary found for '${stateName}' in state data`); }
            else {
              if (stateLayer) map.removeLayer(stateLayer);
              stateLayer = L.geoJSON(feature, {
                style: { color, weight: 2, fillOpacity, opacity: 1 }
              }).addTo(map);
              stateLayer.setZIndex(100);
            }
          }
        }

        if (districtName) {
          const distData = await loadGeoJSON("district_V17.geojson");
          if (distData) {
            const feature = distData.features.find(f => f.properties.Name.toLowerCase() === districtName.toLowerCase());
            if (!feature) { alert(`No boundary found for '${districtName}' in district data`); }
            else {
              if (districtLayer) map.removeLayer(districtLayer);
              districtLayer = L.geoJSON(feature, {
                style: { color, weight: 2, fillOpacity, opacity: 1 }
              }).addTo(map);
              districtLayer.setZIndex(200);
            }
          }
        }

        if (assemblyName) {
          const asmData = await loadGeoJSON("assembly_V17.geojson");
          if (asmData) {
            const feature = asmData.features.find(f => f.properties.Name.toLowerCase() === assemblyName.toLowerCase());
            if (!feature) { alert(`No boundary found for '${assemblyName}' in assembly data`); }
            else {
              if (assemblyLayer) map.removeLayer(assemblyLayer);
              assemblyLayer = L.geoJSON(feature, {
                style: { color, weight: 2, fillOpacity, opacity: 1 }
              }).addTo(map);
              assemblyLayer.setZIndex(300);
            }
          }
        }

        if (lsgName) {
          const lsgData = await loadGeoJSON("lsg_V17.geojson");
          if (lsgData) {
            const feature = lsgData.features.find(f => f.properties.Name.toLowerCase() === lsgName.toLowerCase());
            if (!feature) { alert(`No boundary found for '${lsgName}' in local body data`); }
            else {
              if (lsgLayer) map.removeLayer(lsgLayer);
              lsgLayer = L.geoJSON(feature, {
                style: { color, weight: 2, fillOpacity, opacity: 1 }
              }).addTo(map);
              lsgLayer.setZIndex(400);
            }
          }
        }
      } catch (err) {
        alert("Failed to draw boundary. Please try again");
        console.error("Drawing error:", err);
      } finally {
        document.getElementById("loadingSpinner").style.display = "none";
      }
    }

    function clearBoundaries() {
      if (stateLayer) map.removeLayer(stateLayer);
      if (districtLayer) map.removeLayer(districtLayer);
      if (assemblyLayer) map.removeLayer(assemblyLayer);
      if (lsgLayer) map.removeLayer(lsgLayer);
    }

    document.getElementById("drawBtn").addEventListener("click", drawBoundaries);
    document.getElementById("clearBtn").addEventListener("click", clearBoundaries);
  </script>
</body>
</html>
